pipeline {
    agent any
    tools {
        gradle 'gradle'
    }
    stages {
        stage('Github') {
            steps {
                git branch: 'develop', url: 'https://github.com/MEETWEEN-Organization/MEETWEEN.git'
            }
        }
        stage('Build') {
            steps {
                dir("./backend") {
                    sh "./gradlew clean build"
                }
            }
        }
        stage('SonarQube analysis') {
            steps {
                dir('backend') {
                    withSonarQubeEnv('SonarQube') {
                        sh './gradlew test sonarqube'
                    }
                }
            }
        }
        stage('Deploy') {
           steps {
               dir('backend/build/libs') {
                   sshagent(credentials: ['aws_key']) {
                        sh '''#!/bin/bash

                        RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${BACKEND_DEV_IP}:${BLUE_PORT}")
                        if [ ${RESPONSE_CODE} -ge 100 ]
                        then
                            target_port=${GREEN_PORT}
                        else
                            target_port=${BLUE_PORT}
                        fi
                        echo "${target_port} í¬íŠ¸ë¥¼ target_portë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ğŸ“Œ"


                        scp -o StrictHostKeyChecking=no backend-0.0.1-SNAPSHOT.jar ubuntu@${BACKEND_DEV_IP}:/home/ubuntu
                        ssh ubuntu@${BACKEND_DEV_IP} "sh run.sh ${target_port}" &


                        for retry_count in \$(seq 10)
                        do
                            RESPONSE_CODE_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "http://${BACKEND_DEV_IP}:${target_port}")
                            if [ ${RESPONSE_CODE_HEALTH} -ge 100 ]
                            then
                                echo "Health check ì„±ê³µ âœ… í¬íŠ¸ ë²ˆí˜¸: ${target_port}"
                                break
                            fi

                            if [ $retry_count -eq 10 ]
                            then
                                echo "Health check ì‹¤íŒ¨ âŒ í¬íŠ¸ ë²ˆí˜¸: ${target_port}"
                                exit 1
                            fi

                            echo "ì„œë²„ê°€ ì•„ì§ ê°€ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 10ì´ˆ ë’¤ì— ë‹¤ì‹œ Health checkë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. â±ï¸ ì‹œë„ íšŸìˆ˜: ${retry_count}"
                            sleep 10
                        done


                        ssh ubuntu@${BACKEND_DEV_IP} "echo 'set \\\$service_port ${target_port};' | sudo tee /etc/nginx/conf.d/service-port.inc && sudo service nginx reload"
                        echo "nginxì˜ reverse proxy ë°©í–¥ì„ ${target_port} ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ğŸ”„"


                        if [ "${target_port}" == "${BLUE_PORT}" ]
                        then
                            ssh ubuntu@${BACKEND_DEV_IP} "fuser -s -k ${GREEN_PORT}/tcp"
                        else
                            ssh ubuntu@${BACKEND_DEV_IP} "fuser -s -k ${BLUE_PORT}/tcp"
                        fi

                        echo "ë¹„í™œì„± ì„œë²„ì˜ í”„ë¡œì„¸ìŠ¤ë¥¼ kill í•©ë‹ˆë‹¤. ğŸ”ª"

                        '''
                   }
               }
           }
       }
    }
}